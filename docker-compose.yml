services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8090:8080"
    environment:
      QUARKUS_HTTP_HOST: 0.0.0.0

      # DB della tua app
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://db:5432/mydb
      QUARKUS_DATASOURCE_USERNAME: quarkus
      QUARKUS_DATASOURCE_PASSWORD: quarkus

      # Data Index (per consoles) - visto dal container app (rete docker)
      KOGITO_DATAINDEX_HTTP_URL: http://data-index:8080
      KOGITO_DATAINDEX_WS_URL: ws://data-index:8080

      # URL pubblico del tuo servizio (utile per link dalle console)
      KOGITO_SERVICE_URL: http://localhost:8090

      # Kafka bootstrap (eventi verso Data Index)
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092

    depends_on:
      - db
      - kafka
      - data-index

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: quarkus
      POSTGRES_PASSWORD: quarkus
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./src/main/resources/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"

  # Kafka compatibile (Redpanda)
  kafka:
    image: redpandadata/redpanda:latest
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://kafka:9092
    ports:
      - "9092:9092"

  # DB dedicato a Data Index
  data-index-db:
    image: postgres:15
    environment:
      POSTGRES_DB: kogito_dataindex
      POSTGRES_USER: kogito
      POSTGRES_PASSWORD: kogito
    volumes:
      - pgdata_dataindex:/var/lib/postgresql/data

  # Data Index
  data-index:
    image: quay.io/kiegroup/kogito-data-index-postgresql:1.24
    ports:
      - "8180:8080"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://data-index-db:5432/kogito_dataindex
      QUARKUS_DATASOURCE_USERNAME: kogito
      QUARKUS_DATASOURCE_PASSWORD: kogito

      # FIX: crea/aggiorna lo schema (tabelle processes/tasks/...)
      QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: update

    depends_on:
      - kafka
      - data-index-db

  # Task Console (UI) - deve usare localhost perch√© chiamato dal BROWSER
  task-console:
    image: quay.io/kiegroup/kogito-task-console:1.24
    ports:
      - "8380:8080"
    environment:
      KOGITO_DATAINDEX_HTTP_URL: http://localhost:8180
      KOGITO_DATAINDEX_WS_URL: ws://localhost:8180
    depends_on:
      - data-index

  # Management Console (UI) - idem
  management-console:
    image: quay.io/kiegroup/kogito-management-console:1.24
    ports:
      - "8280:8080"
    environment:
      KOGITO_DATAINDEX_HTTP_URL: http://localhost:8180
      KOGITO_DATAINDEX_WS_URL: ws://localhost:8180
    depends_on:
      - data-index

volumes:
  pgdata:
  pgdata_dataindex:
